<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* VIEWER MODE STYLES */
        .viewer-mode {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .viewer-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            padding: 40px;
            text-align: center;
            max-width: 900px;
            width: 100%;
        }

        .viewer-header {
            margin-bottom: 30px;
        }

        .viewer-header h1 {
            color: #1a202c;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .viewer-header p {
            color: #4a5568;
            font-size: 1.1rem;
        }

        .certificate-display {
            width: 100%;
            max-width: 800px;
            height: 600px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            margin: 0 auto 30px;
        }

        .viewer-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* DESIGNER MODE STYLES */
        .designer-mode .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr 250px;
            gap: 0;
            min-height: 700px;
        }

        .sidebar, .properties-panel {
            background: #f8fafc;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar {
            border-right: 1px solid #e2e8f0;
        }

        .properties-panel {
            border-left: 1px solid #e2e8f0;
        }

        .canvas-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #fafbfc;
            padding: 20px;
            position: relative;
        }

        .design-canvas {
            width: 800px;
            height: 600px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .text-element {
            position: absolute;
            cursor: move;
            padding: 5px;
            border: 2px dashed transparent;
            min-width: 50px;
            min-height: 20px;
            word-wrap: break-word;
            user-select: none;
            z-index: 10;
        }

        .text-element:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .text-element.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 5px 5px 5px 0;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .github-section {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8faff;
        }

        .template-thumbnails {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .template-thumb {
            aspect-ratio: 4/3;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            transition: all 0.3s;
        }

        .template-thumb:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .template-thumb.active {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .element-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            background: white;
        }

        .element-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 5px;
            border: 1px solid transparent;
        }

        .element-item:hover {
            background: #f8fafc;
            border-color: #e5e7eb;
        }

        .element-item.selected {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section h3 {
            margin-bottom: 15px;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .actions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }

        #backgroundImage {
            display: none;
        }

        .participant-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }

        .participant-table th,
        .participant-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .participant-table th {
            background-color: #f8fafc;
            font-weight: 600;
        }

        .id-display {
            font-family: monospace;
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }

        .debug-panel {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin: 15px 0;
            font-size: 12px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .design-canvas, .certificate-display {
                width: 100%;
                max-width: 800px;
                height: 500px;
            }
        }
    </style>
</head>
<body>
    <!-- VIEWER MODE -->
    <div id="viewerMode" class="viewer-mode" style="display: none;">
        <div class="viewer-container">
            <div class="viewer-header">
                <h1>Your Certificate</h1>
                <p id="viewerWelcome">Congratulations on your achievement!</p>
            </div>
            
            <div class="certificate-display" id="certificateDisplay"></div>
            
            <div class="viewer-actions">
                <button class="btn btn-primary" onclick="downloadCertificatePDF()">
                    📄 Download Certificate PDF
                </button>
                <button class="btn btn-secondary" onclick="shareCertificate()">
                    🔗 Share Certificate
                </button>
            </div>
        </div>
    </div>

    <!-- DESIGNER MODE -->
    <div id="designerMode" class="designer-mode">
        <div class="container">
            <div class="header">
                <h1>Certificate Designer</h1>
                <p>Create beautiful certificates with GitHub-hosted images for short URLs</p>
            </div>
            
            <div class="main-content">
                <!-- Left Sidebar -->
                <div class="sidebar">
                    <div class="section">
                        <h3>📁 Background Options</h3>
                        
                        <!-- Templates -->
                        <label>Built-in Templates:</label>
                        <div class="template-thumbnails">
                            <div class="template-thumb" data-template="classic" style="background: linear-gradient(45deg, #ffd700, #ffed4e);" title="Classic Gold"></div>
                            <div class="template-thumb" data-template="modern" style="background: linear-gradient(45deg, #667eea, #764ba2);" title="Modern Blue"></div>
                            <div class="template-thumb" data-template="elegant" style="background: linear-gradient(45deg, #2d3748, #4a5568);" title="Elegant Dark"></div>
                            <div class="template-thumb" data-template="vibrant" style="background: linear-gradient(45deg, #ff6b6b, #feca57);" title="Vibrant Orange"></div>
                        </div>
                        
                        <!-- GitHub Image Section -->
                        <div class="github-section">
                            <div class="form-group">
                                <label>🚀 GitHub Image URL (Recommended - Creates Short URLs)</label>
                                <input type="text" id="githubImageUrl" placeholder="https://yourusername.github.io/certificate-generator/images/design1.jpg" style="font-size: 12px;">
                                <button class="btn btn-primary" onclick="loadGitHubImage()" style="margin-top: 8px; width: 100%;">
                                    🔗 Load GitHub Image
                                </button>
                                <small style="color: #0369a1; font-size: 11px; display: block; margin-top: 8px; line-height: 1.4;">
                                    <strong>💡 Setup Guide:</strong><br>
                                    1. Create <code>/images/</code> folder in your GitHub repo<br>
                                    2. Upload: design1.jpg, cert-bg.png, etc.<br>
                                    3. URL format: https://username.github.io/repo/images/file.jpg<br>
                                    4. Results in SHORT participant URLs ✅
                                </small>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin: 15px 0; color: #6b7280; font-weight: 600;">- OR -</div>
                        
                        <!-- Local Upload -->
                        <div class="upload-area" onclick="document.getElementById('backgroundImage').click()">
                            <div>📤 Upload Local Image</div>
                            <small style="color: #f59e0b;">⚠️ Testing only - Creates VERY long URLs</small>
                        </div>
                        <input type="file" id="backgroundImage" accept="image/*">
                        
                        <button class="btn btn-secondary" onclick="clearBackground()">🗑️ Clear Background</button>
                    </div>
                    
                    <div class="section">
                        <h3>➕ Add Text Elements</h3>
                        <button class="btn btn-primary" onclick="addTextElement('Name', '{{name}}')">👤 Add Name Field</button>
                        <button class="btn btn-primary" onclick="addTextElement('Title', 'Certificate of Achievement')">🏆 Add Title</button>
                        <button class="btn btn-primary" onclick="addTextElement('Course', '{{course}}')">📚 Add Course Field</button>
                        <button class="btn btn-primary" onclick="addTextElement('Date', '{{date}}')">📅 Add Date Field</button>
                        <button class="btn btn-primary" onclick="addTextElement('Authority', 'Issued by Organization')">🏢 Add Authority</button>
                        <button class="btn btn-secondary" onclick="addTextElement('Custom', 'Custom Text')">📝 Add Custom Text</button>
                    </div>
                    
                    <div class="section">
                        <h3>📋 Current Elements</h3>
                        <div class="element-list" id="elementList">
                            <div style="text-align: center; color: #9ca3af; font-style: italic; padding: 20px;">No elements added yet</div>
                        </div>
                    </div>
                </div>
                
                <!-- Canvas Area -->
                <div class="canvas-area">
                    <div class="design-canvas" id="designCanvas"></div>
                    
                    <div class="actions">
                        <button class="btn btn-primary" onclick="downloadPDF()">📄 Download Preview PDF</button>
                        <button class="btn btn-secondary" onclick="saveDesign()">💾 Save Design</button>
                        <button class="btn btn-secondary" onclick="loadDesign()">📂 Load Design</button>
                    </div>
                </div>
                
                <!-- Right Properties Panel -->
                <div class="properties-panel">
                    <div class="section">
                        <h3>🎨 Element Properties</h3>
                        <div id="propertiesContent">
                            <div style="text-align: center; color: #9ca3af; font-style: italic; padding: 20px;">Select an element to edit its properties</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>⚙️ Status</h3>
                        <div class="debug-panel">
                            <div id="debugElements"><strong>Elements:</strong> 0</div>
                            <div id="debugBackground"><strong>Background:</strong> None</div>
                            <div id="debugReady"><strong>Ready:</strong> ❌ Need elements + background</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>🔗 Generate Links</h3>
                        
                        <div class="form-group">
                            <label>Participants (CSV format)</label>
                            <textarea id="participantData" placeholder="John Doe,Web Development,john@email.com&#10;Jane Smith,Data Science,jane@email.com&#10;Mike Johnson,UI/UX Design,mike@email.com" rows="5"></textarea>
                            <small style="color: #6b7280; font-size: 11px;">Format: name,course,email (one per line)</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Issue Date</label>
                            <input type="date" id="issueDate">
                        </div>
                        
                        <button class="btn btn-success" onclick="generateParticipantLinks()" style="width: 100%;">
                            🚀 Generate All Links
                        </button>
                        
                        <div id="participantResults" style="display: none; margin-top: 20px;">
                            <div style="display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap;">
                                <button class="btn btn-secondary" onclick="copyAllParticipantLinks()">📋 Copy All</button>
                                <button class="btn btn-secondary" onclick="downloadParticipantList()">💾 Download List</button>
                                <button class="btn btn-secondary" onclick="generateEmailTemplates()">📧 Email Templates</button>
                            </div>
                            <div style="max-height: 300px; overflow-y: auto;">
                                <table class="participant-table" id="participantTable">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>ID</th>
                                            <th>Link Status</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let elements = [];
        let selectedElement = null;
        let dragElement = null;
        let dragOffset = { x: 0, y: 0 };
        let elementCounter = 0;
        let currentBackground = null;
        let participantDatabase = {};
        let currentMode = 'designer';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            determineMode();
            if (currentMode === 'viewer') {
                initViewerMode();
            } else {
                initDesignerMode();
            }
        });

        function determineMode() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('cert') || urlParams.has('id') || (urlParams.has('name') && urlParams.has('design'))) {
                currentMode = 'viewer';
            } else {
                currentMode = 'designer';
            }
        }

        function initViewerMode() {
            document.getElementById('viewerMode').style.display = 'flex';
            document.getElementById('designerMode').style.display = 'none';
            
            const urlParams = new URLSearchParams(window.location.search);
            let participantData = {};
            
            try {
                if (urlParams.has('cert')) {
                    const encodedData = urlParams.get('cert');
                    participantData = JSON.parse(decodeURIComponent(encodedData));
                } else if (urlParams.has('id')) {
                    const id = urlParams.get('id');
                    const storedData = localStorage.getItem(`cert_${id}`);
                    if (storedData) {
                        participantData = JSON.parse(storedData);
                    }
                } else {
                    const designParam = urlParams.get('design');
                    let designData = {};
                    
                    if (designParam) {
                        try {
                            designData = JSON.parse(decodeURIComponent(designParam));
                        } catch (e) {
                            console.error('Error parsing design data:', e);
                        }
                    }
                    
                    participantData = {
                        name: urlParams.get('name') || 'Certificate Recipient',
                        course: urlParams.get('course') || '',
                        date: urlParams.get('date') || new Date().toISOString().split('T')[0],
                        design: designData
                    };
                }
                
                if (!participantData.name) {
                    throw new Error('No participant data found');
                }
                
                loadCertificateForViewing(participantData);
                
            } catch (error) {
                console.error('Error loading certificate:', error);
                document.getElementById('viewerWelcome').textContent = 'Error loading certificate. Please check your link.';
                document.getElementById('certificateDisplay').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">Certificate could not be loaded</div>';
            }
        }

        function initDesignerMode() {
            document.getElementById('designerMode').style.display = 'block';
            document.getElementById('viewerMode').style.display = 'none';
            
            setupDesignerEventListeners();
            setTodaysDate();
            updateDebugInfo();
        }

        function setupDesignerEventListeners() {
            const canvas = document.getElementById('designCanvas');
            
            canvas.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);
            canvas.addEventListener('click', selectElement);
            
            const fileInput = document.getElementById('backgroundImage');
            fileInput.addEventListener('change', handleFileUpload);
            
            const uploadArea = document.querySelector('.upload-area');
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleFileDrop);
            
            document.querySelectorAll('.template-thumb').forEach(thumb => {
                thumb.addEventListener('click', function() {
                    document.querySelectorAll('.template-thumb').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    setTemplate(this.dataset.template);
                });
            });
        }

        function setTodaysDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('issueDate').value = today;
        }

        // GITHUB IMAGE LOADING FUNCTION
        function loadGitHubImage() {
            const githubUrl = document.getElementById('githubImageUrl').value.trim();
            if (!githubUrl) {
                alert('Please enter a GitHub image URL');
                return;
            }
            
            if (!githubUrl.startsWith('https://') || !githubUrl.includes('github.io')) {
                alert('Please enter a valid GitHub Pages URL (https://username.github.io/...)');
                return;
            }
            
            console.log('Loading GitHub image:', githubUrl);
            
            const testImg = new Image();
            testImg.onload = function() {
                console.log('✅ GitHub image loaded successfully');
                
                const canvas = document.getElementById('designCanvas');
                canvas.style.backgroundImage = `url(${githubUrl})`;
                currentBackground = githubUrl;
                
                document.querySelectorAll('.template-thumb').forEach(t => t.classList.remove('active'));
                updateDebugInfo();
                
                alert('✅ GitHub image loaded! This will create SHORT participant URLs.');
            };
            
            testImg.onerror = function() {
                console.error('❌ Failed to load GitHub image');
                alert('❌ Could not load image. Check:\n\n1. URL is correct\n2. Image exists in your repo\n3. GitHub Pages is enabled\n4. Image is publicly accessible');
            };
            
            testImg.src = githubUrl;
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    setBackgroundImage(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleFileDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    setBackgroundImage(e.target.result);
                };
                reader.readAsDataURL(files[0]);
            }
        }

        function setBackgroundImage(imageData) {
            const canvas = document.getElementById('designCanvas');
            canvas.style.backgroundImage = `url(${imageData})`;
            currentBackground = imageData;
            
            console.log('⚠️ Local image uploaded - will create VERY long URLs');
            console.log('Image size:', Math.round(imageData.length / 1024) + 'KB');
            
            document.querySelectorAll('.template-thumb').forEach(t => t.classList.remove('active'));
            document.getElementById('githubImageUrl').value = '';
            
            updateDebugInfo();
        }

        function setTemplate(template) {
            const canvas = document.getElementById('designCanvas');
            
            switch(template) {
                case 'classic':
                    canvas.style.backgroundImage = 'linear-gradient(45deg, #ffd700, #ffed4e)';
                    currentBackground = 'template-classic';
                    break;
                case 'modern':
                    canvas.style.backgroundImage = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    currentBackground = 'template-modern';
                    break;
                case 'elegant':
                    canvas.style.backgroundImage = 'linear-gradient(45deg, #2d3748, #4a5568)';
                    currentBackground = 'template-elegant';
                    break;
                case 'vibrant':
                    canvas.style.backgroundImage = 'linear-gradient(45deg, #ff6b6b, #feca57)';
                    currentBackground = 'template-vibrant';
                    break;
            }
            
            document.getElementById('githubImageUrl').value = '';
            updateDebugInfo();
        }

        function clearBackground() {
            const canvas = document.getElementById('designCanvas');
            canvas.style.backgroundImage = 'none';
            currentBackground = null;
            document.querySelectorAll('.template-thumb').forEach(t => t.classList.remove('active'));
            document.getElementById('githubImageUrl').value = '';
            updateDebugInfo();
        }

        function addTextElement(type, defaultText) {
            elementCounter++;
            const element = {
                id: `element_${elementCounter}`,
                type: type,
                text: defaultText,
                x: 50 + (elementCounter * 20),
                y: 50 + (elementCounter * 30),
                fontSize: 24,
                fontFamily: 'Arial',
                color: '#000000',
                fontWeight: 'normal',
                fontStyle: 'normal',
                textAlign: 'left'
            };
            
            elements.push(element);
            renderElement(element);
            updateElementList();
            updateDebugInfo();
            selectElementById(element.id);
        }

        function renderElement(element) {
            const canvas = document.getElementById('designCanvas');
            const div = document.createElement('div');
            div.className = 'text-element';
            div.id = element.id;
            div.style.left = element.x + 'px';
            div.style.top = element.y + 'px';
            div.style.fontSize = element.fontSize + 'px';
            div.style.fontFamily = element.fontFamily;
            div.style.color = element.color;
            div.style.fontWeight = element.fontWeight;
            div.style.fontStyle = element.fontStyle;
            div.style.textAlign = element.textAlign;
            div.style.minWidth = element.textAlign === 'center' ? '300px' : 'auto';
            div.textContent = element.text;
            
            canvas.appendChild(div);
        }

        function updateElementList() {
            const list = document.getElementById('elementList');
            if (elements.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #9ca3af; font-style: italic; padding: 20px;">No elements added yet</div>';
                return;
            }
            
            list.innerHTML = elements.map(element => `
                <div class="element-item" onclick="selectElementById('${element.id}')" data-id="${element.id}">
                    <span><strong>${element.type}:</strong> ${element.text.substring(0, 20)}${element.text.length > 20 ? '...' : ''}</span>
                    <button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;" onclick="deleteElement('${element.id}', event)">×</button>
                </div>
            `).join('');
        }

        function selectElement(event) {
            if (event.target.classList.contains('text-element')) {
                selectElementById(event.target.id);
            } else {
                deselectElement();
            }
        }

        function selectElementById(id) {
            deselectElement();
            
            const elementDiv = document.getElementById(id);
            const element = elements.find(e => e.id === id);
            
            if (elementDiv && element) {
                elementDiv.classList.add('selected');
                selectedElement = element;
                updatePropertiesPanel();
                updateElementListSelection();
            }
        }

        function deselectElement() {
            document.querySelectorAll('.text-element.selected').forEach(el => {
                el.classList.remove('selected');
            });
            selectedElement = null;
            updatePropertiesPanel();
            updateElementListSelection();
        }

        function updateElementListSelection() {
            document.querySelectorAll('.element-item').forEach(item => {
                item.classList.remove('selected');
                if (selectedElement && item.dataset.id === selectedElement.id) {
                    item.classList.add('selected');
                }
            });
        }

        function deleteElement(id, event) {
            event.stopPropagation();
            elements = elements.filter(e => e.id !== id);
            document.getElementById(id).remove();
            updateElementList();
            updateDebugInfo();
            if (selectedElement && selectedElement.id === id) {
                deselectElement();
            }
        }

        function updatePropertiesPanel() {
            const panel = document.getElementById('propertiesContent');
            
            if (!selectedElement) {
                panel.innerHTML = '<div style="text-align: center; color: #9ca3af; font-style: italic; padding: 20px;">Select an element to edit its properties</div>';
                return;
            }
            
            panel.innerHTML = `
                <div class="form-group">
                    <label>Text Content</label>
                    <textarea id="propText" rows="3">${selectedElement.text}</textarea>
                </div>
                <div class="form-group">
                    <label>Font Size</label>
                    <input type="number" id="propFontSize" value="${selectedElement.fontSize}" min="8" max="100">
                </div>
                <div class="form-group">
                    <label>Font Family</label>
                    <select id="propFontFamily">
                        <option value="Arial" ${selectedElement.fontFamily === 'Arial' ? 'selected' : ''}>Arial</option>
                        <option value="Georgia" ${selectedElement.fontFamily === 'Georgia' ? 'selected' : ''}>Georgia</option>
                        <option value="Times New Roman" ${selectedElement.fontFamily === 'Times New Roman' ? 'selected' : ''}>Times New Roman</option>
                        <option value="Helvetica" ${selectedElement.fontFamily === 'Helvetica' ? 'selected' : ''}>Helvetica</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Text Color</label>
                    <input type="color" id="propColor" value="${selectedElement.color}">
                </div>
                <div class="form-group">
                    <label>Font Weight</label>
                    <select id="propFontWeight">
                        <option value="normal" ${selectedElement.fontWeight === 'normal' ? 'selected' : ''}>Normal</option>
                        <option value="bold" ${selectedElement.fontWeight === 'bold' ? 'selected' : ''}>Bold</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="applyProperties()">✅ Apply Changes</button>
            `;
        }

        function applyProperties() {
            if (!selectedElement) return;
            
            selectedElement.text = document.getElementById('propText').value;
            selectedElement.fontSize = parseInt(document.getElementById('propFontSize').value);
            selectedElement.fontFamily = document.getElementById('propFontFamily').value;
            selectedElement.color = document.getElementById('propColor').value;
            selectedElement.fontWeight = document.getElementById('propFontWeight').value;
            
            updateElementDisplay(selectedElement);
            updateElementList();
        }

        function updateElementDisplay(element) {
            const div = document.getElementById(element.id);
            div.style.fontSize = element.fontSize + 'px';
            div.style.fontFamily = element.fontFamily;
            div.style.color = element.color;
            div.style.fontWeight = element.fontWeight;
            div.textContent = element.text;
        }

        function updateDebugInfo() {
            const elementCount = elements.length;
            const hasBackground = !!currentBackground;
            
            let backgroundType = '❌ None';
            if (currentBackground) {
                if (currentBackground.startsWith('https://')) {
                    backgroundType = `🚀 GitHub Image (SHORT URLs)`;
                } else if (currentBackground.startsWith('data:')) {
                    const sizeKB = Math.round(currentBackground.length / 1024);
                    backgroundType = `📷 Local Image (${sizeKB}KB - LONG URLs)`;
                } else if (currentBackground.startsWith('template-')) {
                    backgroundType = `🎨 Template (SHORT URLs)`;
                }
            }
            
            const isReady = elementCount > 0 && hasBackground;
            
            document.getElementById('debugElements').innerHTML = `<strong>Elements:</strong> ${elementCount}`;
            document.getElementById('debugBackground').innerHTML = `<strong>Background:</strong> ${backgroundType}`;
            document.getElementById('debugReady').innerHTML = `<strong>Ready:</strong> ${isReady ? '✅ Ready to generate!' : '❌ Need elements + background'}`;
        }

        // PARTICIPANT LINK GENERATION
        function generateParticipantLinks() {
            const participantText = document.getElementById('participantData').value.trim();
            if (!participantText) {
                alert('Please enter participant data in CSV format');
                return;
            }

            if (elements.length === 0) {
                alert('Please add at least one text element first!');
                return;
            }

            const lines = participantText.split('\n').filter(line => line.trim());
            const participants = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const parts = line.split(',').map(p => p.trim());
                if (parts.length >= 1) {
                    participants.push({
                        name: parts[0] || '',
                        course: parts[1] || '',
                        email: parts[2] || '',
                        id: generateMaskedId()
                    });
                }
            }

            if (participants.length === 0) {
                alert('No valid participant data found');
                return;
            }

            const designData = {
                elements: elements.map(el => ({...el})),
                background: currentBackground,
                backgroundType: currentBackground?.startsWith('https://') ? 'github-url' : 
                               currentBackground?.startsWith('data:') ? 'base64' : 
                               currentBackground?.startsWith('template-') ? 'template' : 'none',
                canvasWidth: 800,
                canvasHeight: 600
            };

            const issueDate = document.getElementById('issueDate').value;
            const baseUrl = window.location.href.split('?')[0];

            const participantLinks = participants.map(participant => {
                const certificateData = {
                    name: participant.name,
                    course: participant.course,
                    email: participant.email,
                    date: issueDate,
                    design: designData
                };

                const jsonString = JSON.stringify(certificateData);
                const encodedData = encodeURIComponent(jsonString);
                const fullUrl = `${baseUrl}?cert=${encodedData}`;
                
                try {
                    localStorage.setItem(`cert_${participant.id}`, jsonString);
                } catch(e) {
                    console.warn('localStorage failed:', e);
                }
                
                return {
                    ...participant,
                    url: fullUrl,
                    urlLength: fullUrl.length,
                    isOptimized: designData.backgroundType === 'github-url',
                    backgroundType: designData.backgroundType
                };
            });

            displayParticipantResults(participantLinks);
            window.generatedParticipantLinks = participantLinks;
        }

        function generateMaskedId() {
            return Math.random().toString(36).substr(2, 9);
        }

        function displayParticipantResults(participants) {
            const resultsDiv = document.getElementById('participantResults');
            const tableBody = document.querySelector('#participantTable tbody');
            
            const rows = participants.map(participant => {
                const urlLength = participant.urlLength;
                let statusIcon, statusText, rowColor;
                
                if (participant.isOptimized) {
                    statusIcon = '🚀';
                    statusText = `Optimized (${urlLength} chars)`;
                    rowColor = '#f0f9ff';
                } else if (urlLength < 2000) {
                    statusIcon = '✅';
                    statusText = `Good (${urlLength} chars)`;
                    rowColor = '#f0fdf4';
                } else if (urlLength < 8000) {
                    statusIcon = '⚠️';
                    statusText = `Long (${urlLength} chars)`;
                    rowColor = '#fffbeb';
                } else {
                    statusIcon = '❌';
                    statusText = `Very Long (${urlLength} chars)`;
                    rowColor = '#fef2f2';
                }
                
                return `
                <tr style="background: ${rowColor};">
                    <td>${participant.name}</td>
                    <td><span class="id-display">${participant.id}</span></td>
                    <td style="font-size: 10px;">
                        <div>${statusIcon} ${statusText}</div>
                        <div style="color: #666; font-size: 9px;">
                            ${participant.backgroundType === 'github-url' ? '🌐 GitHub Image' : 
                              participant.backgroundType === 'template' ? '🎨 Template' : 
                              participant.backgroundType === 'base64' ? '📷 Embedded Image' : 'Other'}
                        </div>
                    </td>
                </tr>
            `}).join('');
            
            tableBody.innerHTML = rows;
            resultsDiv.style.display = 'block';
            
            const optimizedCount = participants.filter(p => p.isOptimized).length;
            const errorCount = participants.filter(p => p.urlLength >= 8000).length;
            
            if (errorCount > 0) {
                alert(`⚠️ Warning: ${errorCount} URLs are very long (>8000 chars) and may not work in all email clients.\n\nRecommendation: Use GitHub images for shorter URLs.`);
            }
        }

        function copyAllParticipantLinks() {
            if (!window.generatedParticipantLinks) return;
            
            const text = window.generatedParticipantLinks.map(participant => 
                `${participant.name}: ${participant.url}`
            ).join('\n\n');
            
            navigator.clipboard.writeText(text).then(() => {
                alert('All links copied to clipboard!');
            });
        }

        function downloadParticipantList() {
            if (!window.generatedParticipantLinks) return;
            
            const content = [
                'Certificate Links Generated on ' + new Date().toLocaleDateString(),
                '='.repeat(60),
                '',
                'PERSONALIZED CERTIFICATE LINKS:',
                '',
                ...window.generatedParticipantLinks.map(participant => 
                    `${participant.name}: ${participant.url}`
                ),
                '',
                'Instructions for participants:',
                '1. Click your personal link',
                '2. Your certificate loads automatically',
                '3. Click "Download Certificate PDF"',
                '',
                `Total: ${window.generatedParticipantLinks.length} participants`
            ].join('\n');
            
            const blob = new Blob([content], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'certificate_links.txt';
            link.click();
        }

        function generateEmailTemplates() {
            if (!window.generatedParticipantLinks) return;
            
            const templates = window.generatedParticipantLinks.map(participant => `
=== EMAIL FOR: ${participant.name.toUpperCase()} ===

Subject: 🎉 Your Certificate is Ready!

Hi ${participant.name},

Congratulations! Your certificate is ready for download.

🏆 Your Certificate Link: ${participant.url}

Instructions:
• Click the link above
• Your certificate loads automatically
• Click "Download Certificate PDF"

Best regards,
[Your Organization]
---
            `).join('\n');
            
            const blob = new Blob([templates], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'email_templates.txt';
            link.click();
        }

        // Drag and drop functionality
        function startDrag(event) {
            if (event.target.classList.contains('text-element')) {
                dragElement = event.target;
                const rect = dragElement.getBoundingClientRect();
                const canvasRect = document.getElementById('designCanvas').getBoundingClientRect();
                
                dragOffset.x = event.clientX - rect.left;
                dragOffset.y = event.clientY - rect.top;
                
                event.preventDefault();
            }
        }

        function drag(event) {
            if (dragElement) {
                const canvasRect = document.getElementById('designCanvas').getBoundingClientRect();
                const x = event.clientX - canvasRect.left - dragOffset.x;
                const y = event.clientY - canvasRect.top - dragOffset.y;
                
                dragElement.style.left = Math.max(0, Math.min(x, canvasRect.width - dragElement.offsetWidth)) + 'px';
                dragElement.style.top = Math.max(0, Math.min(y, canvasRect.height - dragElement.offsetHeight)) + 'px';
                
                const element = elements.find(e => e.id === dragElement.id);
                if (element) {
                    element.x = parseInt(dragElement.style.left);
                    element.y = parseInt(dragElement.style.top);
                }
            }
        }

        function endDrag() {
            dragElement = null;
        }

        // Certificate viewing functions
        function loadCertificateForViewing(participantData) {
            try {
                let designData = participantData.design;
                if (typeof designData === 'string') {
                    designData = JSON.parse(decodeURIComponent(designData));
                }
                
                if (!designData || typeof designData !== 'object') {
                    designData = {};
                }
                
                document.getElementById('viewerWelcome').textContent = 
                    `Congratulations ${participantData.name}!`;
                
                const display = document.getElementById('certificateDisplay');
                display.innerHTML = '';
                
                // Apply background
                if (designData.background) {
                    const backgroundType = designData.backgroundType || 'auto-detect';
                    
                    if (backgroundType === 'github-url' || designData.background.startsWith('https://')) {
                        display.style.backgroundImage = `url(${designData.background})`;
                    } else if (backgroundType === 'base64' || designData.background.startsWith('data:')) {
                        display.style.backgroundImage = `url(${designData.background})`;
                    } else if (backgroundType === 'template' || designData.background.startsWith('template-')) {
                        const template = designData.background.replace('template-', '');
                        switch(template) {
                            case 'classic':
                                display.style.backgroundImage = 'linear-gradient(45deg, #ffd700, #ffed4e)';
                                break;
                            case 'modern':
                                display.style.backgroundImage = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                                break;
                            case 'elegant':
                                display.style.backgroundImage = 'linear-gradient(45deg, #2d3748, #4a5568)';
                                break;
                            case 'vibrant':
                                display.style.backgroundImage = 'linear-gradient(45deg, #ff6b6b, #feca57)';
                                break;
                        }
                    } else {
                        display.style.backgroundImage = `url(${designData.background})`;
                    }
                } else {
                    display.style.backgroundImage = 'linear-gradient(45deg, #ffd700, #ffed4e)';
                }
                
                // Apply canvas size
                display.style.width = (designData.canvasWidth || 800) + 'px';
                display.style.height = (designData.canvasHeight || 600) + 'px';
                
                // Render elements with high quality
                if (designData.elements && Array.isArray(designData.elements)) {
                    designData.elements.forEach(element => {
                        const div = document.createElement('div');
                        div.style.position = 'absolute';
                        div.style.left = (element.x || 50) + 'px';
                        div.style.top = (element.y || 50) + 'px';
                        div.style.fontSize = (element.fontSize || 24) + 'px';
                        div.style.fontFamily = element.fontFamily || 'Arial';
                        div.style.color = element.color || '#000000';
                        div.style.fontWeight = element.fontWeight || 'normal';
                        div.style.textAlign = element.textAlign || 'left';
                        div.style.minWidth = element.textAlign === 'center' ? '300px' : 'auto';
                        // High quality text rendering
                        div.style.webkitFontSmoothing = 'antialiased';
                        div.style.mozOsxFontSmoothing = 'grayscale';
                        div.style.textRendering = 'optimizeLegibility';
                        
                        let displayText = element.text || '';
                        displayText = displayText.replace('{{name}}', participantData.name || '[Name]');
                        displayText = displayText.replace('{{course}}', participantData.course || '[Course]');
                        displayText = displayText.replace('{{date}}', formatDate(participantData.date));
                        
                        div.textContent = displayText;
                        display.appendChild(div);
                    });
                }
                
            } catch (error) {
                console.error('Error loading certificate:', error);
                document.getElementById('viewerWelcome').textContent = 'Error loading certificate';
                document.getElementById('certificateDisplay').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">Certificate could not be loaded</div>';
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'Today';
            try {
                return new Date(dateStr).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (e) {
                return dateStr;
            }
        }

        // PDF download for viewer
        async function downloadCertificatePDF() {
            const { jsPDF } = window.jspdf;
            const certificate = document.getElementById('certificateDisplay');
            
            try {
                const canvas = await html2canvas(certificate, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                });
                
                const pdf = new jsPDF('landscape', 'mm', 'a4');
                const imgWidth = 297;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight);
                
                const urlParams = new URLSearchParams(window.location.search);
                let filename = 'Certificate.pdf';
                
                if (urlParams.has('id')) {
                    const data = JSON.parse(localStorage.getItem(`cert_${urlParams.get('id')}`));
                    if (data?.name) {
                        filename = `${data.name.replace(/\s+/g, '_')}_Certificate.pdf`;
                    }
                }
                
                pdf.save(filename);
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF. Please try again.');
            }
        }

        function shareCertificate() {
            const url = window.location.href;
            
            if (navigator.share) {
                navigator.share({
                    title: 'My Certificate',
                    text: 'Check out my certificate!',
                    url: url
                });
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    alert('Certificate link copied to clipboard!');
                });
            }
        }

        // PDF download for designer
        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const canvas = document.getElementById('designCanvas');
            
            const selected = document.querySelector('.text-element.selected');
            if (selected) {
                selected.classList.remove('selected');
            }
            
            try {
                const htmlCanvas = await html2canvas(canvas, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                });
                
                const pdf = new jsPDF('landscape', 'mm', 'a4');
                const imgWidth = 297;
                const imgHeight = (htmlCanvas.height * imgWidth) / htmlCanvas.width;
                
                pdf.addImage(htmlCanvas.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight);
                pdf.save('Certificate_Template.pdf');
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF. Please try again.');
            } finally {
                if (selected) {
                    selected.classList.add('selected');
                }
            }
        }

        function saveDesign() {
            const designData = {
                elements: elements,
                background: currentBackground,
                canvasWidth: 800,
                canvasHeight: 600
            };
            
            const dataStr = JSON.stringify(designData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'certificate_design.json';
            link.click();
        }

        function loadDesign() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const designData = JSON.parse(e.target.result);
                            
                            if (designData.background) {
                                if (designData.background.startsWith('https://')) {
                                    document.getElementById('githubImageUrl').value = designData.background;
                                    loadGitHubImage();
                                } else {
                                    currentBackground = designData.background;
                                    document.getElementById('designCanvas').style.backgroundImage = `url(${designData.background})`;
                                }
                            }
                            
                            if (designData.elements) {
                                elements = designData.elements;
                                elementCounter = Math.max(...elements.map(e => parseInt(e.id.split('_')[1]))) || 0;
                                
                                document.querySelectorAll('.text-element').forEach(el => el.remove());
                                
                                elements.forEach(element => {
                                    renderElement(element);
                                });
                                
                                updateElementList();
                                updateDebugInfo();
                            }
                        } catch (error) {
                            alert('Error loading design file');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
    </script>
</body>
</html>
